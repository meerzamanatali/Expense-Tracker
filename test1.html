<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Expense Tracker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <style>
    body {
      background-color: #f8f9fa;
    }

    .card {
      border: none;
      border-radius: 1rem;
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
    }

    .balance-card .card-body {
      padding: 1.5rem;
    }

    .balance-card h5 {
      font-weight: 600;
      color: #6c757d;
    }

    .balance-card .display-4 {
      font-weight: 700;
    }

    .table-container {
      overflow-x: auto;
    }

    .table thead th {
      white-space: nowrap;
    }

    .table tbody td {
      white-space: nowrap;
    }

    .form-label {
      font-weight: 500;
    }

    .form-control,
    .form-select {
      border-radius: 0.5rem;
    }

    .btn-custom {
      border-radius: 0.5rem;
      font-weight: 600;
    }

    @media (max-width: 767.98px) {
      .table tbody td {
        font-size: 0.8rem;
      }

      .btn-group .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
      }
    }
  </style>
</head>

<body>

  <div class="container py-4">

    <div id="init-panel" class="row justify-content-center" style="display: none;">
      <div class="col-md-6">
        <div class="card p-4">
          <h2 class="text-center mb-4">Initialize Balances</h2>
          <form id="init-form">
            <div class="mb-3">
              <label for="init-cash" class="form-label">Cash (‚Ç¨)</label>
              <input type="number" step="0.01" class="form-control" id="init-cash" value="0">
            </div>
            <div class="mb-3">
              <label for="init-bank" class="form-label">Bank (‚Ç¨)</label>
              <input type="number" step="0.01" class="form-control" id="init-bank" value="0">
            </div>
            <div class="mb-3">
              <label for="init-block" class="form-label">Block (‚Ç¨)</label>
              <input type="number" step="0.01" class="form-control" id="init-block" value="0">
            </div>
            <button type="submit" class="btn btn-primary w-100 btn-custom">Save Balances</button>
          </form>
        </div>
      </div>
    </div>

    <div id="main-content" style="display: none;">

      <div class="row g-3 mb-4">
        <div class="col-md-4">
          <div class="card bg-success-subtle text-success balance-card">
            <div class="card-body text-center">
              <h5 class="card-title">Cash üí∏</h5>
              <p class="card-text display-4" id="balance-cash">‚Ç¨ 0.00</p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card bg-primary-subtle text-primary balance-card">
            <div class="card-body text-center">
              <h5 class="card-title">Bank üè¶</h5>
              <p class="card-text display-4" id="balance-bank">‚Ç¨ 0.00</p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card bg-warning-subtle text-warning balance-card">
            <div class="card-body text-center">
              <h5 class="card-title">Block üîí</h5>
              <p class="card-text display-4" id="balance-block">‚Ç¨ 0.00</p>
            </div>
          </div>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-body">
          <h4 class="card-title mb-3">Add Transaction</h4>
          <form id="transaction-form">
            <div class="row g-3">
              <div class="col-md-2">
                <label for="date" class="form-label">Date</label>
                <input type="date" class="form-control" id="date" required>
              </div>
              <div class="col-md-2">
                <label for="things" class="form-label">Things</label>
                <input type="text" class="form-control" id="things" placeholder="e.g., Coffee">
              </div>
              <div class="col-md-1">
                <label for="quantity" class="form-label">Qty</label>
                <input type="number" class="form-control" id="quantity" placeholder="0">
              </div>
              <div class="col-md-1">
                <label for="unit" class="form-label">Unit</label>
                <input type="text" class="form-control" id="unit" placeholder="e.g., L">
              </div>
              <div class="col-md-2">
                <label for="category" class="form-label">Category</label>
                <input type="text" class="form-control" id="category" placeholder="e.g., Groceries">
              </div>
              <div class="col-md-2">
                <label for="place" class="form-label">Place</label>
                <input type="text" class="form-control" id="place" placeholder="e.g., Lidl">
              </div>
              <div class="col-md-1">
                <label for="mode" class="form-label">Mode</label>
                <select class="form-select" id="mode">
                  <option value="C" title="Cash transaction">Cash</option>
                  <option value="O" title="Online/Bank transaction">Online</option>
                </select>
              </div>
              <div class="col-md-1">
                <label for="type" class="form-label">Type</label>
                <select class="form-select" id="type">
                  <option value="S" title="Outgoing expense">Spend</option>
                  <option value="D" title="Incoming income">Deposit</option>
                  <option value="TD" title="Transfer between accounts">Transfer</option>
                </select>
              </div>
              <div class="col-md-2">
                <label for="amount" class="form-label">Amount</label>
                <input type="number" step="0.01" class="form-control" id="amount" required placeholder="0.00">
              </div>
              <div class="col-md-2 d-grid">
                <button type="submit" class="btn btn-success btn-custom" id="form-submit-btn">Add Transaction</button>
              </div>
            </div>
            <div id="transfer-panel" class="row g-3 mt-3" style="display:none;">
              <div class="col-md-2">
                <label for="transfer-from" class="form-label">From Account</label>
                <select class="form-select" id="transfer-from">
                  <option value="bank">Bank</option>
                  <option value="cash">Cash</option>
                  <option value="block">Block</option>
                </select>
              </div>
              <div class="col-md-2">
                <label for="transfer-to" class="form-label">To Account</label>
                <select class="form-select" id="transfer-to">
                  <option value="block">Block</option>
                  <option value="bank">Bank</option>
                  <option value="cash">Cash</option>
                </select>
              </div>
            </div>
          </form>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
            <h4 class="card-title mb-2 mb-md-0">Transaction History</h4>
            <div class="btn-group flex-wrap">
              <button class="btn btn-warning btn-custom" data-bs-toggle="modal"
                data-bs-target="#reinitializeModal">Reinitialize Balances</button>
              <button class="btn btn-secondary btn-custom" onclick="exportData('csv')">Export CSV</button>
              <button class="btn btn-info btn-custom" onclick="exportData('xlsx')">Export XLSX</button>
              <label class="btn btn-success btn-custom">
                Import CSV
                <input type="file" id="import-csv" accept=".csv" class="d-none">
              </label>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Sr.no</th>
                  <th>Date</th>
                  <th>Things</th>
                  <th>Qty</th>
                  <th>Unit</th>
                  <th>Category</th>
                  <th>Place</th>
                  <th>Mode</th>
                  <th>Type</th>
                  <th>Amount</th>
                  <th>Cash Bal</th>
                  <th>Bank Bal</th>
                  <th>Block Bal</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="transaction-table-body">
                <tr>
                  <td colspan="14" class="text-center text-muted">No transactions yet. Add one above!</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="d-grid mt-3">
            <button class="btn btn-danger btn-custom" data-bs-toggle="modal" data-bs-target="#clearAllModal">Clear All
              Transactions</button>
          </div>
        </div>
      </div>

    </div>

  </div>

  <div class="modal fade" id="clearAllModal" tabindex="-1" aria-labelledby="clearAllModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="clearAllModalLabel">Confirm Deletion</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete all transactions? This action cannot be undone.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" onclick="clearAllTransactions()" data-bs-dismiss="modal">Delete
            All</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="reinitializeModal" tabindex="-1" aria-labelledby="reinitializeModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="reinitializeModalLabel">Confirm Reinitialization</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to reinitialize all balances? This will **permanently delete all transactions** and
          reset your balances to zero.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-warning" onclick="reinitializeApp()"
            data-bs-dismiss="modal">Reinitialize</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    const state = {
      initialState: null,
      transactions: []
    };

    const elements = {
      initPanel: document.getElementById('init-panel'),
      mainContent: document.getElementById('main-content'),
      initForm: document.getElementById('init-form'),
      transactionForm: document.getElementById('transaction-form'),
      transactionTableBody: document.getElementById('transaction-table-body'),
      balanceCash: document.getElementById('balance-cash'),
      balanceBank: document.getElementById('balance-bank'),
      balanceBlock: document.getElementById('balance-block'),
      transferPanel: document.getElementById('transfer-panel'),
      typeSelect: document.getElementById('type'),
      importCsvInput: document.getElementById('import-csv'),
      formSubmitBtn: document.getElementById('form-submit-btn'),
      dateInput: document.getElementById('date'),
    };

    // --- Core Logic ---

    const getLocalStorage = (key) => {
      try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : null;
      } catch (e) {
        console.error(`Error retrieving ${key} from localStorage:`, e);
        return null;
      }
    };

    const setLocalStorage = (key, value) => {
      try {
        localStorage.setItem(key, JSON.stringify(value));
      } catch (e) {
        console.error(`Error saving ${key} to localStorage:`, e);
      }
    };

    const clearLocalStorage = () => {
      try {
        localStorage.removeItem('initialState');
        localStorage.removeItem('transactions');
      } catch (e) {
        console.error('Error clearing localStorage:', e);
      }
    };


    const formatCurrency = (amount) => {
      // The amount is stored in cents, so we divide by 100 to display correctly
      return `‚Ç¨ ${parseFloat(amount / 100).toFixed(2)}`;
    };

    const updateBalancesUI = (balances) => {
      elements.balanceCash.textContent = formatCurrency(balances.cash);
      elements.balanceBank.textContent = formatCurrency(balances.bank);
      elements.balanceBlock.textContent = formatCurrency(balances.block);
    };

    const calculateBalances = (transactions, initialState) => {
      let balances = { ...initialState };
      return transactions.map(t => {
        const amount = Math.round(t.amount * 100);

        if (t.type === 'TD') {
          const from = t.transferFrom || 'bank';
          const to = t.transferTo || 'block';
          balances[from] -= amount;
          balances[to] += amount;
        } else {
          const account = t.mode === 'C' ? 'cash' : 'bank';
          if (t.type === 'S') {
            balances[account] -= amount;
          } else if (t.type === 'D') {
            balances[account] += amount;
          }
        }

        return {
          ...t,
          balanceCash: balances.cash,
          balanceBank: balances.bank,
          balanceBlock: balances.block,
        };
      });
    };

    const renderTransactions = () => {
      elements.transactionTableBody.innerHTML = '';

      const transactionsWithSrNo = state.transactions
        .sort((a, b) => b.id - a.id)
        .map((t, index) => ({
          ...t,
          srNo: state.transactions.length - index,
        }));

      const finalBalances = {
        cash: state.initialState.cash,
        bank: state.initialState.bank,
        block: state.initialState.block,
      };

      const updatedTransactions = calculateBalances(transactionsWithSrNo.reverse(), finalBalances).reverse();

      if (updatedTransactions.length === 0) {
        const emptyRow = document.createElement('tr');
        emptyRow.innerHTML = '<td colspan="14" class="text-center text-muted">No transactions yet. Add one above!</td>';
        elements.transactionTableBody.appendChild(emptyRow);
        updateBalancesUI(finalBalances);
      } else {
        updatedTransactions.forEach(t => {
          const row = document.createElement('tr');
          row.innerHTML = `
                        <td>${t.srNo}</td>
                        <td>${t.date}</td>
                        <td>${t.things}</td>
                        <td>${t.quantity}</td>
                        <td>${t.unit}</td>
                        <td>${t.category}</td>
                        <td>${t.place}</td>
                        <td>${t.mode}</td>
                        <td>${t.type}</td>
                        <td>${formatCurrency(t.amount * 100)}</td>
                        <td>${formatCurrency(t.balanceCash)}</td>
                        <td>${formatCurrency(t.balanceBank)}</td>
                        <td>${formatCurrency(t.balanceBlock)}</td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-info text-white" onclick="editTransaction(${t.id})">
                                    <i class="bi bi-pencil-square"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteTransaction(${t.id})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
          elements.transactionTableBody.appendChild(row);
        });

        const lastTransaction = updatedTransactions[0];
        updateBalancesUI({
          cash: lastTransaction.balanceCash,
          bank: lastTransaction.balanceBank,
          block: lastTransaction.balanceBlock,
        });
      }

      setLocalStorage('transactions', state.transactions);
    };

    // --- Event Handlers ---

    const initializeApp = () => {
      const storedState = getLocalStorage('initialState');
      if (storedState) {
        state.initialState = {
          cash: Math.round(parseFloat(storedState.cash)),
          bank: Math.round(parseFloat(storedState.bank)),
          block: Math.round(parseFloat(storedState.block)),
        };
        state.transactions = getLocalStorage('transactions') || [];
        elements.initPanel.style.display = 'none';
        elements.mainContent.style.display = 'block';
        renderTransactions();
      } else {
        elements.initPanel.style.display = 'flex';
        elements.mainContent.style.display = 'none';
      }
    };

    elements.initForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const cash = parseFloat(document.getElementById('init-cash').value) || 0;
      const bank = parseFloat(document.getElementById('init-bank').value) || 0;
      const block = parseFloat(document.getElementById('init-block').value) || 0;

      state.initialState = {
        cash: Math.round(cash * 100),
        bank: Math.round(bank * 100),
        block: Math.round(block * 100),
      };
      setLocalStorage('initialState', state.initialState);
      initializeApp();
    });

    elements.transactionForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const form = e.target;
      const isEditing = form.dataset.editing === 'true';

      const newTransaction = {
        id: isEditing ? parseInt(form.dataset.editId) : Date.now(),
        date: elements.dateInput.value,
        things: form.things.value,
        quantity: form.quantity.value ? parseFloat(form.quantity.value) : 0,
        unit: form.unit.value,
        category: form.category.value,
        place: form.place.value,
        mode: form.mode.value,
        type: form.type.value,
        amount: parseFloat(form.amount.value),
      };

      if (newTransaction.type === 'TD') {
        newTransaction.transferFrom = document.getElementById('transfer-from').value;
        newTransaction.transferTo = document.getElementById('transfer-to').value;
      }

      if (isEditing) {
        const index = state.transactions.findIndex(t => t.id === newTransaction.id);
        if (index !== -1) {
          state.transactions[index] = newTransaction;
        }
      } else {
        state.transactions.unshift(newTransaction);
      }

      form.reset();
      elements.dateInput.value = new Date().toISOString().substring(0, 10);
      elements.formSubmitBtn.textContent = 'Add Transaction';
      form.dataset.editing = 'false';
      document.getElementById('mode').value = 'C';
      document.getElementById('type').value = 'S';
      elements.transferPanel.style.display = 'none';

      renderTransactions();
    });

    elements.typeSelect.addEventListener('change', (e) => {
      elements.transferPanel.style.display = e.target.value === 'TD' ? 'flex' : 'none';
    });

    window.editTransaction = (id) => {
      const transaction = state.transactions.find(t => t.id === id);
      if (!transaction) return;

      elements.transactionForm.dataset.editing = 'true';
      elements.transactionForm.dataset.editId = transaction.id;

      document.getElementById('date').value = transaction.date;
      document.getElementById('things').value = transaction.things;
      document.getElementById('quantity').value = transaction.quantity;
      document.getElementById('unit').value = transaction.unit;
      document.getElementById('category').value = transaction.category;
      document.getElementById('place').value = transaction.place;
      document.getElementById('mode').value = transaction.mode;
      document.getElementById('type').value = transaction.type;
      document.getElementById('amount').value = transaction.amount;

      if (transaction.type === 'TD') {
        elements.transferPanel.style.display = 'flex';
        document.getElementById('transfer-from').value = transaction.transferFrom || 'bank';
        document.getElementById('transfer-to').value = transaction.transferTo || 'block';
      } else {
        elements.transferPanel.style.display = 'none';
      }

      elements.formSubmitBtn.textContent = 'Update Transaction';
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    };

    window.deleteTransaction = (id) => {
      state.transactions = state.transactions.filter(t => t.id !== id);
      renderTransactions();
    };

    window.clearAllTransactions = () => {
      state.transactions = [];
      setLocalStorage('transactions', []);
      renderTransactions();
    };

    window.reinitializeApp = () => {
      clearLocalStorage();
      window.location.reload();
    };

    window.exportData = (format) => {
      const dataToExport = state.transactions.map(t => ({
        'Sr.no': t.srNo,
        'Date': t.date,
        'Things': t.things,
        'Quantity': t.quantity,
        'Unit': t.unit,
        'Category': t.category,
        'Place': t.place,
        'Mode': t.mode,
        'Type': t.type,
        'Amount': parseFloat(t.amount).toFixed(2),
        'BalanceCash': formatCurrency(t.balanceCash),
        'BalanceBank': formatCurrency(t.balanceBank),
        'BalanceBlock': formatCurrency(t.balanceBlock),
      }));

      if (format === 'csv') {
        const csv = Papa.unparse(dataToExport);
        const blob = new Blob([csv], {
          type: 'text/csv;charset=utf-8;'
        });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.setAttribute('download', 'transactions.csv');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } else if (format === 'xlsx') {
        const worksheet = XLSX.utils.json_to_sheet(dataToExport);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'transactions');
        XLSX.writeFile(workbook, 'transactions.xlsx');
      }
    };

    elements.importCsvInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      Papa.parse(file, {
        header: true,
        dynamicTyping: true,
        complete: (results) => {
          const importedTransactions = results.data.filter(row => row.Date).map(row => ({
            id: Date.now() + Math.random(),
            date: row.Date,
            things: row.Things,
            quantity: row.Quantity || 0,
            unit: row.Unit || '',
            category: row.Category || '',
            place: row.Place || '',
            mode: row.Mode,
            type: row.Type,
            amount: parseFloat(row.Amount) || 0,
            transferFrom: row.transferFrom || undefined,
            transferTo: row.transferTo || undefined,
          }));

          state.transactions = [...importedTransactions, ...state.transactions];
          renderTransactions();
          alert('Transactions imported successfully!');
        }
      });
      e.target.value = ''; // Reset input for next import
    });

    // Set initial date
    elements.dateInput.value = new Date().toISOString().substring(0, 10);

    // Initial application load
    initializeApp();
  </script>
</body>

</html>